name: "Test"

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        xcode: ["13.4.1", "13.3.1", "13.2.1"]
        include:
          - xcode: "13.4.1"
            macos: macos-12
          - xcode: "13.3.1"
            macos: macos-12
          - xcode: "13.2.1"
            macos: macos-12
    runs-on: ${{ matrix.macos }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app; swift -version
      - name: Get Swift Version
        id: get-swift-version
        run: |
          echo "::set-output name=version::$(swift -version | head -n 1 | sed s/,// )"
      - name: Danger
        run: |
          brew install danger/tap/danger-swift
          danger-swift ci
        env:
          GITHUB_TOKEN: ${{ secrets.DANGER_GITHUB_API_TOKEN }}
      - name: Cache dependencies
        uses: actions/cache@v2
        with:
          path: |
            .build/artifacts
            .build/checkouts
            .build/repositories
          key: ${{ runner.os }}-dependencies-${{ matrix.xcode }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-dependencies-${{ matrix.xcode }}-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-dependencies-${{ matrix.xcode }}-
      - name: Test
        run: swift test

